@page "/profile"
@page "/profile/{username?}"

<!-- Usings -->
@using StriveUp.Shared.DTOs
@using StriveUp.Shared.DTOs.Profile

<!-- Injections -->
@inject IAuthService AuthService
@inject ICustomAuthStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IProfileService ProfileService
@inject IPlatformService PlatformService
@inject IJSRuntime JSRuntime
@inject IActivityService ActivityService
@implements IDisposable

<PageTitle>Profile</PageTitle>

<div class="container py-5">
    @if (isLoading)
    {
        <Spinner text="Loading profile. Please wait..."></Spinner>
    }
    else if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else
    {
        @if (isLoading)
        {
            <Spinner text="Loading profile..."></Spinner>
        }
        else if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        else
        {
            <!-- Profile Header -->
            <div class="profile-card mb-4 position-relative row p-3 mt-0 mt-md-3">
                <!-- Avatar, Overlapping and Centered at the Left Border of the Card -->
                <div class="col-12 col-md-4 col-lg-3 d-flex justify-content-center justify-content-md-start">
                    <div class="avatar-overlay-container">
                        <img src="@GetAvatarUrl()" alt="Avatar" class="profile-avatar-overlay" />
                    </div>
                </div>

                <div class="col-12 col-md-8 col-lg-9 d-flex flex-column">
                    <div class="ms-0 ms-md-5">
                        <!-- User Name and Full Name -->
                        <h4 class="fw-bold mb-0">@userProfile.UserName</h4>
                        <p class="text-muted mb-1">@userProfile.FirstName @userProfile.LastName</p>

                        <!-- Location Info -->
                        <div class="mb-2 text-muted">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            @FormatLocation(userProfile.City, userProfile.State, userProfile.Country)
                        </div>

                        @if (userProfile?.Birthday != null)
                        {
                            <span><i class="bi bi-cake2"></i> @userProfile.Birthday.Value.ToShortDateString()</span>
                        }

                        <!-- XP & Level -->
                        <div class="d-flex align-items-center mt-3 level-info text-end">
                            <i class="fas fa-star me-2 text-warning"></i>
                            <strong>Level @userProfile.LevelNumber</strong>
                            <span class="ms-2 text-muted small">@userProfile.CurrentXP / @userProfile.LevelTotalXP XP</span>
                        </div>
                        <div class="progress my-2" style="height: 6px; max-width: 300px; width: 100%;">
                            <div class="progress-bar bg-warning" role="progressbar"
                                    style="width: @(XPProgress)%;" aria-valuenow="@XPProgress"
                                    aria-valuemin="0" aria-valuemax="100"></div>
                        </div>

                        <!-- Followers / Following -->
                        <div class="d-flex flex-wrap gap-3 mt-3 mb-md-0 mb-2">
                            <div class="text-muted">
                                <i class="fas fa-users me-1"></i>
                                <strong>@userProfile.Followers.Count</strong> Followers
                            </div>
                            <div class="text-muted">
                                <i class="fas fa-user-plus me-1"></i>
                                <strong>@userProfile.Following.Count</strong> Following
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Buttons (Editable section) -->
                @if (isEditable)
                {
                    <div class="profile-actions d-flex flex-column text-end ms-auto col-12 col-md-2">
                        <button class="btn btn-outline-secondary btn-sm mb-2" @onclick="HandleEdit">
                            <i class="fas fa-edit me-1"></i> Edit Profile
                        </button>
                        <button class="btn btn-outline-danger btn-sm" @onclick="HandleLogout">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </button>
                    </div>
                }
            </div>
        }

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button @(activeTab == "activities" ? "active" : "")" @onclick="@(() => activeTab = "activities")">
                <i class="bi bi-activity me-1"></i> Activities
            </button>
            <button class="tab-button @(activeTab == "medals" ? "active" : "")" @onclick="@(() => activeTab = "medals")">
                <i class="bi bi-award me-1"></i> Medals
            </button>
        </div>


        <!-- Activities Tab -->
        @if (activeTab == "activities")
        {
            <div>
                @if (pagedActivities.Any())
                {
                    <div class="row g-3">
                        @foreach (var activity in pagedActivities)
                        {
                            <ActivityCard Activity="activity" />
                        }
                    </div>

                    @if (isActivitiesLoading && activityPage > 1)
                    {
                        <Spinner isSmall="true"></Spinner>
                    }
                    else if (hasMoreActivities)
                    {
                        <div @ref="sentinel" style="height: 1px;"></div>
                    }
                }
                else if (isActivitiesLoading)
                {
                    <Spinner isSmall="false"></Spinner>
                }
                else
                {   
                    @if (isEditable)
                    {
                        <p class="text-muted">No activities recorded yet.</p>

                        <!-- Encourage user to do an activity -->
                        @if (PlatformService.IsNativeApp())
                        {
                            <div class="alert alert-info">
                                <p>Start tracking your activities now! <a href="/tracking" class="btn btn-primary">Go to Tracking</a></p>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <p>Start tracking your activities! Download our app from Google Play:</p>
                                <a href="https://play.google.com/store/apps/details?id=com.striveup.app" class="btn btn-primary" target="_blank">
                                    Download the App
                                </a>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">@userName has not recorded any activity yet.</p>
                    }
                }
            </div>
        }

        <!-- Medals Tab -->
        @if (activeTab == "medals")
        {
            <div>
                <h5 class="mb-3">Earned Medals</h5>
                @if (userProfile.Medals?.Any() == true)
                {
                    <div class="row g-4">
                        @for (int i = 0; i < userProfile.Medals.Count; i++)
                        {
                            var medal = userProfile.Medals[i];
                            <div class="col-6 col-sm-4 col-md-2 medal-drop-animation" style="animation-delay:@($"{i * 45}ms")">
                                <MedalCard MedalDto="medal" IsAchieved=true />
                            </div>
                        }
                    </div>
                }
                else
                {
                    @if (isEditable)
                    {
                        <p class="text-muted">No medals earned yet.</p>
                    }
                    else
                    {
                        <p class="text-muted">@userName has not earned any medal yet.</p>
                    }
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public string? Username { get; set; }
    private List<UserActivityDto> pagedActivities = new();
    private bool isActivitiesLoading = false;
    private bool hasMoreActivities = true;
    private int activityPage = 1;
    private const int ActivityPageSize = 6;
    private ElementReference sentinel;
    private bool observerInitialized = false;
    private DotNetObjectReference<UserProfile>? dotNetRef;
    private bool isLoading = true;
    private string? errorMessage;
    private UserProfileDto userProfile = new();
    private bool isEditable = false;
    private string userName = "";
    private string activeTab = "activities";
    private int XPProgress => userProfile.LevelTotalXP == 0
        ? 0
        : (int)((double)userProfile.CurrentXP / userProfile.LevelTotalXP * 100);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadInitialProfile();

            if (activeTab == "activities")
            {
                await LoadMoreActivities();
            }
        }

        if (activeTab == "activities" && hasMoreActivities && sentinel.Id != null && !observerInitialized)
        {
            try
            {
                dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("initIntersectionObserver", sentinel, dotNetRef);
                observerInitialized = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"JS interop error: {ex}");
            }
        }
    }


    private async Task LoadInitialProfile()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var currentUser = authState.User;

        if (currentUser.Identity?.IsAuthenticated == true)
        {
            userName = Username ?? currentUser.Identity.Name;

            var (success, error, profile) = await ProfileService.GetProfile(userName);

            if (success && profile != null)
            {
                userProfile = profile;
                isEditable = (userName == currentUser.Identity?.Name);
            }
            else
            {
                errorMessage = error?.Message + Environment.NewLine + error?.Details ?? "An unexpected error occurred.";
            }
        }
        else
        {
            errorMessage = "You are not authenticated.";
        }

        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task LoadMoreActivities()
    {
        try
        {
            if (isActivitiesLoading || !hasMoreActivities) return;

            isActivitiesLoading = true;
            StateHasChanged();

            var pageActivities = await ActivityService.GetUserActivitiesAsync(activityPage, ActivityPageSize);

            if (pageActivities != null)
            {
                if (pageActivities.Count < ActivityPageSize)
                {
                    hasMoreActivities = false;
                }

                pagedActivities.AddRange(pageActivities);
                activityPage++;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
        finally
        {
            isActivitiesLoading = false;
            StateHasChanged();
        }
    }



    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    private async Task HandleEdit()
    {
        Navigation.NavigateTo("/profile/edit");
    }

    private string GetAvatarUrl() => userProfile.Avatar;

    private string FormatLocation(string? city, string? state, string? country)
    {
        var parts = new[] { city, state, country }.Where(x => !string.IsNullOrWhiteSpace(x));
        return parts.Any() ? string.Join(", ", parts) : "Location not set";
    }

    private void SetTab(string tab)
    {
        activeTab = tab;
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
    }
}
