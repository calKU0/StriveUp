@page "/tracking"
@inject IJSRuntime JSRuntime
@inject IActivityService ActivityService
@inject ISecurableService SecurableService
@inject IBleHeartRateService HeartRateService
@inject NavigationManager Navigation

@using Microsoft.Maui
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Maui.Devices.Sensors
@using StriveUp.Shared.Components
@using StriveUp.Shared.DTOs
@using StriveUp.Shared.DTOs.Activity
@using System.Diagnostics
@using Plugin.BLE.Abstractions.Contracts;


@if (isLoadingLocation)
{
    <div class="loading-overlay">
        <div class="spinner"></div>
        <p class="loading-text">Acquiring GPS. Please wait...</p>
    </div>
}

<div class="page-wrapper @(mapVisible ? "map-visible" : "")">
    <div class="slides">
        <div class="map-section">
            <div id="map"></div>
        </div>

        <div class="controls">
            <ActivityControls AvailableActivities="availableActivities"
            SelectedActivityId="@selectedActivityId"
            IsTracking="@isTracking"
            IsPaused="@isPaused"
            OnSelectedSensorChanged="@(sensor => ConnectHrDevice(sensor))"
            OnStartClick="@ToggleTracking"
            OnStopClick="@ToggleTracking"
            OnResumeClick="@ResumeTracking"
            OnFinishClick="@ShowFinishModal" />
        </div>
    </div>
    @if (isTracking || isPaused)
    {
        <div class="slides @(isSheetExpanded ? "expanded" : "")">
            <div class="tiles-wrapper container-fluid flex-grow-1 d-flex align-items-stretch">
                <!-- Info Tiles -->
                <div class="row g-3">
                    <InfoTile Label="Distance" Value="@($"{Math.Round(Distance, 2):F2} km")" />
                    <InfoTile Label="Speed" Value="@($"{Math.Round(Speed, 2):F2} km/h")" />
                    <InfoTile Label="Heart Rate" Value="@($"{HeartRate} bpm")" />
                    <InfoTile Label="Duration" Value="@Duration.ToString(@"hh\:mm\:ss")" />
                    <InfoTile Label="Tile 5" Value="--" />
                    <InfoTile Label="Tile 6" Value="--" />
                </div>
            </div>
        </div>
    }

</div>

<FinishModal Show="@showFinishModal"
Duration="@Duration"
Title="@activityTitle"
Description="@activityDescription"
OnSave="@SaveActivityWithMeta"
OnDiscard="@DiscardActivity"
OnResume="@ResumeTracking" />



@code {
    private List<ActivityHrDto> HrData = new();
    private string selectedDeviceId;
    private List<Location> route = new();
    private List<ActivityDto> availableActivities = new();
    private bool isPaused = false;
    private int selectedActivityId = 4;
    private bool isTracking = false;
    private bool mapVisible = false;
    private bool mapInitialized = false;
    private Location currentLocation;
    private double Distance = 0;
    private double Speed = 0;
    private int HeartRate = 0;
    private TimeSpan Duration = TimeSpan.Zero;
    private DateTime startTime;
    private double currentHeading = 0;
    private CancellationTokenSource durationCts;
    private bool isLoadingLocation = true;
    private string mapToken;
    private bool btPermission = false;
    private bool isSheetExpanded = false;

    private bool showFinishModal = false;
    private string activityTitle = "My Activity";
    private string activityDescription = "Tracked via GPS";

    // This will be triggered when the page first loads
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var status = await Permissions.RequestAsync<Permissions.Bluetooth>();
        if (status != PermissionStatus.Granted)
        {
            btPermission = false;
            return;
        }
        btPermission = true;
        var activities = await ActivityService.GetAvailableActivitiesAsync();
        if (activities != null)
            availableActivities = activities;

        mapToken = await SecurableService.GetMapboxTokenAsync();
        await StartLocationTracking(); // Start tracking immediately
        Navigation.LocationChanged += HandleLocationChanged;
    }  

    private async Task StartLocationTracking()
    {
        try
        {
            var status = await Permissions.RequestAsync<Permissions.LocationWhenInUse>();
            if (status != PermissionStatus.Granted)
            {
                isLoadingLocation = false;
                return;
            }

            while (currentLocation == null)
            {
                var location = await Geolocation.GetLocationAsync(new GeolocationRequest(GeolocationAccuracy.High));

                if (location != null)
                {
                    StartCompass();
                    currentLocation = location;

                    if (!mapInitialized)
                    {
                        mapInitialized = true;
                        mapVisible = true;
                        Debug.WriteLine(mapToken);
                        await JSRuntime.InvokeVoidAsync("initializeMap", location.Latitude, location.Longitude, mapToken);
                    }

                    await JSRuntime.InvokeVoidAsync("updateMap", currentLocation.Latitude, currentLocation.Longitude, currentHeading, isTracking);
                    isLoadingLocation = false;
                    StateHasChanged();
                }

                await Task.Delay(1500);
            }

            Geolocation.LocationChanged += OnLocationChanged;
            var request = new GeolocationListeningRequest(GeolocationAccuracy.High);
            await Geolocation.StartListeningForegroundAsync(request);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Location error: " + ex.Message);
            isLoadingLocation = false;
        }
    }


    private void OnLocationChanged(object sender, GeolocationLocationChangedEventArgs e)
    {
        currentLocation = e.Location;
        JSRuntime.InvokeVoidAsync("updateMap", currentLocation.Latitude, currentLocation.Longitude, currentHeading, isTracking);
    }

    private async Task ConnectHrDevice(BluetoothDeviceDto device)
    {
        selectedDeviceId = device.Id;
        var success = await HeartRateService.ConnectAsync(selectedDeviceId);
        if (success)
        {
            HeartRateService.OnHeartRateChanged += (hr) =>
            {
                if (isTracking)
                {
                    HeartRate = hr;
                    HrData.Add(new ActivityHrDto
                        {
                            HearthRateValue = hr,
                            TimeStamp = DateTime.UtcNow
                        });
                    Debug.WriteLine($"Heart Rate: {hr} bpm");
                }

                InvokeAsync(StateHasChanged);
            };
        }
    }

    private void ToggleSheet()
    {
        isSheetExpanded = !isSheetExpanded;
    }

    private void ToggleTracking()
    {
        if (isTracking)
        {
            _ = StopTracking();
        }
        else
        {
            _ = StartTracking();
        }
    }


    private async Task StartTracking()
    {
        isTracking = true;
        startTime = DateTime.UtcNow;
        route.Clear();
        durationCts = new CancellationTokenSource();

        _ = Task.Run(() => TrackActivity()); 
        _ = Task.Run(() => UpdateDuration(durationCts.Token)); 
    }

    private async Task TrackActivity()
    {
        try
        {
            while (isTracking)
            {
                if (currentLocation != null)
                {
                    if (route.Count > 0)
                    {
                        var lastLocation = route.Last();
                        Distance += Location.CalculateDistance(lastLocation, currentLocation, DistanceUnits.Kilometers);
                    }

                    route.Add(currentLocation);

                    Speed = currentLocation.Speed.HasValue && currentLocation.Speed.Value > 0
                        ? currentLocation.Speed.Value * 3.6 // m/s to km/h
                        : (Distance / Duration.TotalHours); // fallback estimate

                    await InvokeAsync(() => StateHasChanged());
                }

                await Task.Delay(3000);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Tracking error: " + ex.Message);
        }
    }


    private async Task UpdateDuration(CancellationToken token)
    {
        while (!token.IsCancellationRequested)
        {
            Duration = DateTime.UtcNow - startTime;

            await InvokeAsync(() => StateHasChanged());
            await Task.Delay(1000, token);
        }
    }

    private async Task StopTracking()
    {
        isTracking = false;
        isPaused = true;
        durationCts?.Cancel();
        StateHasChanged();
    }

    private async Task ResumeTracking()
    {
        isPaused = false;
        showFinishModal = false;
        isTracking = true;
        durationCts = new CancellationTokenSource();

        _ = Task.Run(() => TrackActivity());
        _ = Task.Run(() => UpdateDuration(durationCts.Token));
    }

    private void ShowFinishModal()
    {
        showFinishModal = true;
    }

    private async Task DiscardActivity()
    {
        await JSRuntime.InvokeVoidAsync("clearRoute");

        showFinishModal = false;
        isPaused = false;
        Distance = 0;
        Speed = 0;
        Duration = TimeSpan.Zero;
        route.Clear();
        StateHasChanged();
    }

    private async Task SaveActivityWithMeta()
    {
        var dto = new CreateUserActivityDto
            {
                Title = activityTitle,
                Description = activityDescription,
                ActivityId = selectedActivityId,
                DateStart = startTime,
                DateEnd = DateTime.UtcNow,
                DurationSeconds = Duration.TotalSeconds,
                Route = route.Select(loc => new GeoPointDto
                {
                    Latitude = loc.Latitude,
                    Longitude = loc.Longitude,
                    Timestamp = loc.Timestamp.UtcDateTime,
                }).ToList(),
                HrData = HrData
            };

        await ActivityService.AddActivityAsync(dto);
        await JSRuntime.InvokeVoidAsync("clearRoute");

        showFinishModal = false;
        isPaused = false;
        Distance = 0;
        Duration = TimeSpan.Zero;
        Speed = 0;
        route.Clear();

        Compass.Default.Stop();
        Compass.Default.ReadingChanged -= OnCompassReadingChanged;

        Geolocation.Default.StopListeningForeground();
        Geolocation.LocationChanged -= OnLocationChanged;

        Navigation.NavigateTo("/feed");
    }

    private void StartCompass()
    {
        if (!Compass.Default.IsSupported)
        {
            return;
        }

        Compass.Default.ReadingChanged += OnCompassReadingChanged;
        Compass.Default.Start(SensorSpeed.UI);
    }

    private void OnCompassReadingChanged(object sender, CompassChangedEventArgs e)
    {
        if (currentLocation == null)
        {
            return;
        }
        JSRuntime.InvokeVoidAsync("updateMap", currentLocation.Latitude, currentLocation.Longitude, currentHeading, isTracking);
        currentHeading = e.Reading.HeadingMagneticNorth;
    }

    private void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    {
        // Handle cleanup here if needed (e.g., saving data or canceling tasks)
        Dispose();
    }

    private void Dispose()
    {
        // Unsubscribe when the component is disposed to avoid memory leaks
        Compass.Default.Stop();
        Geolocation.Default.StopListeningForeground();
        Geolocation.LocationChanged -= OnLocationChanged;
        Compass.Default.ReadingChanged -= OnCompassReadingChanged;
    }
}

