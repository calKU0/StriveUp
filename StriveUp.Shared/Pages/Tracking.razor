@page "/tracking"
@inject IJSRuntime JSRuntime
@inject IActivityService activityService
@inject NavigationManager Navigation
@using Microsoft.Maui
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Maui.Devices.Sensors
@using StriveUp.Shared.Components
@using StriveUp.Shared.DTOs
@using StriveUp.Shared.DTOs.Activity


@if (isLoadingLocation)
{
    <div class="loading-overlay">
        <div class="spinner"></div>
        <p class="loading-text">Acquiring GPS. Please wait...</p>
    </div>
}

<div class="page-wrapper @(mapVisible ? "map-visible" : "")">
    @if (!isTracking && !isPaused)
    {
        <BackButton />
    }

    <div class="map-section @(!isTracking && !isPaused ? "pt-5" : "")">
        <div id="map"></div>
    </div>

    <div class="controls">
        <ActivityControls AvailableActivities="availableActivities"
        SelectedActivityId="@selectedActivityId"
        IsTracking="@isTracking"
        IsPaused="@isPaused"
        OnStartClick="@ToggleTracking"
        OnStopClick="@ToggleTracking"
        OnResumeClick="@ResumeTracking"
        OnFinishClick="@ShowFinishModal" />
    </div>

    @if (isTracking || isPaused)
    {
        <div id="bottomSheet" class="bottom-sheet ">
            <div class="drag-handle"></div>
        <div class="tiles-wrapper container-fluid flex-grow-1 d-flex align-items-stretch">
            <!-- Info Tiles -->
            <div class="row g-3">
                <InfoTile Label="Distance" Value="@($"{Math.Round(Distance, 2):F2} km")" />
                <InfoTile Label="Speed" Value="@($"{Math.Round(Speed, 2):F2} km/h")" />
                <InfoTile Label="Heart Rate" Value="@($"{HeartRate} bpm")" />
                <InfoTile Label="Duration" Value="@Duration.ToString(@"hh\:mm\:ss")" />
                <InfoTile Label="Tile 5" Value="--" />
                <InfoTile Label="Tile 6" Value="--" />
            </div>
        </div>
    </div>
    }

</div>

<FinishModal Show="@showFinishModal"
             Duration="@Duration"
             Title="@activityTitle"
             Description="@activityDescription"
             OnSave="@SaveActivityWithMeta"
             OnDiscard="@DiscardActivity"
             OnResume="@ResumeTracking" />



@code {
    private List<ActivityDto> availableActivities = new();
    private bool isPaused = false;
    private int selectedActivityId = 4;
    private bool isTracking = false;
    private bool mapVisible = false;
    private bool mapInitialized = false;
    private Location currentLocation;
    private double Distance = 0;
    private double Speed = 0;
    private int HeartRate = 0;
    private TimeSpan Duration = TimeSpan.Zero;
    private DateTime startTime;
    private double currentHeading = 30; // Store the current heading
    private List<Location> route = new();
    private CancellationTokenSource durationCts;
    private bool isLoadingLocation = true;

    private bool showFinishModal = false;
    private string activityTitle = "My Activity";
    private string activityDescription = "Tracked via GPS";

    // This will be triggered when the page first loads
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var activities = await activityService.GetAvailableActivitiesAsync();
            if (activities != null)
                availableActivities = activities;
            await StartLocationTracking(); // Start tracking immediately
            await JSRuntime.InvokeVoidAsync("handleSwipe", "bottomSheet");
        }
    }

    private async Task StartLocationTracking()
    {
        try
        {
            var status = await Permissions.RequestAsync<Permissions.LocationWhenInUse>();
            if (status != PermissionStatus.Granted)
            {
                isLoadingLocation = false;
                return;
            }

            while (currentLocation == null)
            {
                var location = await Geolocation.GetLocationAsync(new GeolocationRequest(GeolocationAccuracy.High));

                if (location != null)
                {
                    currentLocation = location;

                    if (!mapInitialized)
                    {
                        mapInitialized = true;
                        mapVisible = true;
                        await JSRuntime.InvokeVoidAsync("initializeMap", location.Latitude, location.Longitude);
                    }

                    await JSRuntime.InvokeVoidAsync("updateMap", currentLocation.Latitude, currentLocation.Longitude, currentHeading, isTracking);
                    isLoadingLocation = false;
                    StateHasChanged();
                }

                await Task.Delay(1500);
            }
            await StartLocationUpdates();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Location error: " + ex.Message);
            isLoadingLocation = false;
        }
    }

    private async Task StartLocationUpdates()
    {
        var status = await Permissions.RequestAsync<Permissions.LocationWhenInUse>();
        if (status != PermissionStatus.Granted)
        {
            return;
        }

        Geolocation.LocationChanged += OnLocationChanged;

        var request = new GeolocationListeningRequest(GeolocationAccuracy.High);
        await Geolocation.StartListeningForegroundAsync(request);
    }

    private void OnLocationChanged(object sender, GeolocationLocationChangedEventArgs e)
    {
        currentLocation = e.Location;
        JSRuntime.InvokeVoidAsync("updateMap", currentLocation.Latitude, currentLocation.Longitude, currentHeading, isTracking);
    }

    private void ToggleTracking()
    {
        if (isTracking)
        {
            _ = StopTracking();
        }
        else
        {
            _ = StartTracking();
        }
    }


    private async Task StartTracking()
    {
        isTracking = true;
        startTime = DateTime.UtcNow;
        route.Clear();
        durationCts = new CancellationTokenSource();

        _ = Task.Run(() => TrackActivity()); 
        _ = Task.Run(() => UpdateDuration(durationCts.Token)); 
    }

    private async Task TrackActivity()
    {
        try
        {
            while (isTracking)
            {
                if (currentLocation != null)
                {
                    if (route.Count > 0)
                    {
                        var lastLocation = route.Last();
                        Distance += Location.CalculateDistance(lastLocation, currentLocation, DistanceUnits.Kilometers);
                    }

                    route.Add(currentLocation);

                    Speed = currentLocation.Speed.HasValue && currentLocation.Speed.Value > 0
                        ? currentLocation.Speed.Value * 3.6 // m/s to km/h
                        : (Distance / Duration.TotalHours); // fallback estimate

                    await InvokeAsync(() => StateHasChanged());
                }

                await Task.Delay(3000);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Tracking error: " + ex.Message);
        }
    }


    private async Task UpdateDuration(CancellationToken token)
    {
        while (!token.IsCancellationRequested)
        {
            Duration = DateTime.UtcNow - startTime;

            await InvokeAsync(() => StateHasChanged());
            await Task.Delay(1000, token);
        }
    }

    private async Task StopTracking()
    {
        isTracking = false;
        isPaused = true;
        durationCts?.Cancel();
        StateHasChanged();
    }

    private async Task ResumeTracking()
    {
        isPaused = false;
        showFinishModal = false;
        isTracking = true;
        durationCts = new CancellationTokenSource();

        _ = Task.Run(() => TrackActivity());
        _ = Task.Run(() => UpdateDuration(durationCts.Token));
    }

    private void ShowFinishModal()
    {
        showFinishModal = true;
    }

    private async Task DiscardActivity()
    {
        await JSRuntime.InvokeVoidAsync("clearRoute");

        showFinishModal = false;
        isPaused = false;
        Distance = 0;
        Speed = 0;
        Duration = TimeSpan.Zero;
        route.Clear();
        StateHasChanged();
    }

    private async Task SaveActivityWithMeta()
    {
        var dto = new CreateUserActivityDto
            {
                Title = activityTitle,
                Description = activityDescription,
                ActivityId = selectedActivityId,
                DateStart = startTime,
                DateEnd = DateTime.UtcNow,
                DurationMinutes = (int)Duration.TotalMinutes,
                Route = route.Select(loc => new GeoPointDto
                {
                    Latitude = loc.Latitude,
                    Longitude = loc.Longitude,
                    Timestamp = DateTime.UtcNow
                }).ToList()
            };

        await activityService.AddActivityAsync(dto);
        await JSRuntime.InvokeVoidAsync("clearRoute");

        showFinishModal = false;
        isPaused = false;
        Distance = 0;
        Duration = TimeSpan.Zero;
        Speed = 0;
        route.Clear();

        Compass.Default.Stop();
        Compass.Default.ReadingChanged -= OnCompassReadingChanged;

        Geolocation.Default.StopListeningForeground();
        Geolocation.LocationChanged -= OnLocationChanged;

        Navigation.NavigateTo("/feed");
    }

    private void StartCompass()
    {
        if (!Compass.Default.IsSupported)
        {
            return;
        }

        Compass.Default.ReadingChanged += OnCompassReadingChanged;
        Compass.Default.Start(SensorSpeed.UI);
    }

    private void OnCompassReadingChanged(object sender, CompassChangedEventArgs e)
    {
        currentHeading = e.Reading.HeadingMagneticNorth;
    }
}

